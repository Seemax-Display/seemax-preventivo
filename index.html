<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seemax - Foglio Preventivo</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#0a2a3a;
      --card:#ffffff;
      --ink:#101828;
      --muted:#667085;
      --line:#d0d5dd;
      --soft:#eef2ff;
      --accent:#2563eb;
      --danger:#ef4444;
      --red:#ef4444;
      --blue:#2563eb;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background: radial-gradient(1200px 600px at 50% 25%, #163a5a 0%, var(--bg1) 55%, #050813 100%);
    }

    /* Top bar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 14px 14px;
      background: linear-gradient(180deg, rgba(6,10,24,0.92) 0%, rgba(6,10,24,0.65) 100%);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .topbarInner{
      max-width: 1100px;
      margin: 0 auto;
      display:flex;
      justify-content:center;
      gap:12px;
      align-items:center;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 14px;
      cursor:pointer;
      transition: transform .04s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn:hover{background: rgba(255,255,255,0.10)}
    .btnPrimary{
      background: rgba(37,99,235,0.95);
      border-color: rgba(37,99,235,1);
    }
    .btnPrimary:hover{background: rgba(37,99,235,1)}
    .btnDanger{
      background: rgba(239,68,68,0.16);
      border-color: rgba(239,68,68,0.55);
    }
    .btnDanger:hover{background: rgba(239,68,68,0.22)}
    .btn[disabled]{opacity:.5; cursor:not-allowed}

    /* Card */
    .wrap{
      padding: 26px 14px 40px;
    }
    .sheet{
      max-width: 900px;
      margin: 0 auto;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 18px 60px rgba(0,0,0,0.45);
      padding: 26px 26px 22px;
    }

    .header{
      display:grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 18px;
      align-items:start;
    }
    
    .logoBanner{
      background: #f3f6ff;
      border: 1px solid #e6ecff;
      border-radius: 12px;
      /* bigger logo area like your red rectangle */
      height: 112px;
      padding: 0 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
/* No stretch: height fixed, width auto */
    
    /* Never stretch: keep aspect ratio */
    .logoImg{
      height: 100%;
      width: auto;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      object-position: center;
      display:block;
    }
.metaGrid{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap: 10px 14px;
      align-items:center;
    }
    .label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
    }
    .field{
      border:0;
      border-bottom: 1px solid #cbd5e1;
      padding: 6px 2px;
      font-size: 13px;
      outline:none;
      width: 100%;
      background: transparent;
    }
    .field:focus{border-bottom-color: var(--accent)}
    .select{
      border:0;
      border-bottom: 1px solid #cbd5e1;
      padding: 6px 2px;
      font-size: 13px;
      outline:none;
      background: transparent;
      width:100%;
    }

    .titleRow{
      margin-top: 14px;
      display:flex;
      align-items:flex-end;
      gap: 14px;
    }
    .titleRow h1{
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.14em;
      font-weight: 900;
    }
    .redLine{
      height: 4px;
      background: var(--red);
      flex: 1;
      border-radius: 999px;
      transform: translateY(-2px);
    }

    .section{
      margin-top: 14px;
    }
    .section h2{
      margin: 0 0 10px;
      font-size: 12px;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      color: #101828;
    }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 18px;
    }

    .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap: 10px 12px;
      align-items:center;
    }

    /* Items table */
    .itemsWrap{
      background: #f6f8ff;
      border: 1px solid #e6ecff;
      border-radius: 12px;
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse: collapse;
    }
    thead th{
      text-align:left;
      font-size: 12px;
      color:#101828;
      padding: 10px 10px;
      background: #eef2ff;
      border-bottom: 1px solid #e6ecff;
      font-weight: 800;
    }
    tbody td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(230,236,255,0.9);
      vertical-align: middle;
      font-size: 13px;
    }
    tbody tr:last-child td{border-bottom:0}
    .colNum{width: 34px; color: var(--muted); font-weight: 700}
    .colDesc{width: 44%;}
    .colSmall{width: 84px;}
    .colTiny{width: 72px;}
    .colTotal{width: 130px; font-weight: 900; text-align:right; white-space:nowrap;}
    .cellInput{
      width:100%;
      border:1px solid #d0d5dd;
      background:#fff;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      outline:none;
    }
    .cellInput:focus{border-color: var(--accent)}
    .cellInputNum{text-align:center}
    .removeBtn{
      border:0;
      background: rgba(239,68,68,0.12);
      color: #b42318;
      font-weight: 900;
      width: 30px;
      height: 30px;
      border-radius: 10px;
      cursor:pointer;
    }
    .hint{
      font-size: 11px;
      color: var(--muted);
      padding: 8px 10px 12px;
    }
    .blueRule{
      height: 4px;
      background: var(--blue);
      border-radius: 999px;
      margin-top: 10px;
    }

    .bottomGrid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1.35fr 0.85fr;
      gap: 16px;
      align-items:start;
    }
    .noteBox{
      border: 1px solid #d0d5dd;
      border-radius: 12px;
      padding: 10px 10px;
      min-height: 96px;
      width:100%;
      font-size: 13px;
      outline:none;
      resize: vertical;
    }
    .summary{
      background: #f6f8ff;
      border: 1px solid #e6ecff;
      border-radius: 12px;
      overflow:hidden;
    }
    .summary h3{
      margin: 0;
      padding: 10px 12px;
      font-size: 12px;
      letter-spacing: .10em;
      text-transform: uppercase;
      background: #eef2ff;
      border-bottom: 1px solid #e6ecff;
    }
    .sumRow{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(230,236,255,0.9);
      font-size: 13px;
    }
    .sumRow:last-child{border-bottom:0}
    .sumRow strong{font-weight: 900}
    .sumTotal{
      font-weight: 900;
      font-size: 14px;
    }

    /* Mobile */
    @media (max-width: 780px){
      .sheet{padding: 16px 14px
      .logoBanner{height: 88px;}
}
      .header{grid-template-columns: 1fr; gap: 14px;}
      .metaGrid{grid-template-columns: 110px 1fr;}
      .twoCol{grid-template-columns: 1fr;}
      .kv{grid-template-columns: 110px 1fr;}
      .bottomGrid{grid-template-columns: 1fr;}
      .itemsWrap{overflow-x:auto}
      .colDesc{min-width: 260px;}
      .colTotal{min-width: 120px;}
    }

    /* PDF summary: hidden off-screen */
    .pdfRoot{
      position: fixed;
      left: -99999px;
      top: 0;
      width: 210mm;
      min-height: 297mm;
      background: #fff;
      color: #101828;
      padding: 14mm;
    }
    .pdfRoot .sheet{box-shadow:none; border-radius: 0; padding:0;}
    .pdfRoot .topbar{display:none}
    .pdfRoot .cellInput, .pdfRoot .removeBtn{display:none !important}
    .pdfText{
      font-size: 13px;
      padding: 8px 10px;
      border: 1px solid transparent;
      border-radius: 10px;
      background: transparent;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .pdfRoot .itemsWrap{background:#f6f8ff}
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(17,24,39,0.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 100;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }
  
    .topHint{
      color: rgba(255,255,255,.75);
      font-size: 12px;
      margin: 0 10px 0 6px;
      user-select: none;
      white-space: nowrap;
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    /* PDF signature */
    .signRow{ display:flex; gap:18px; margin-top:14px; }
    .signBox{ flex:1; border:1px solid #d0d5dd; border-radius:12px; padding:10px 12px; }
    .signTitle{ font-size:10px; color:#475467; margin-bottom:12px; }
    .signLine{ border-bottom:1px solid #98a2b3; height:18px; }

  </style>
</head>
<body>

  <div class="topbar">
    <div class="topbarInner">
      <button id="btnAdd" class="btn">+ Riga</button>
      <span class="topHint">Max 5 righe</span>
      <button id="btnReset" class="btn btnDanger">Reset</button>
      <button id="btnPdf" class="btn btnPrimary">Scarica PDF</button>
    </div>
  </div>

  <div class="wrap">
    <div class="sheet" id="uiRoot">

      <div class="header">
        <div class="logoBanner">
          <img class="logoImg" id="logoImg" src="./logo.png" alt="Seemax" />
        </div>

        <div class="metaGrid">
          <div class="label">Numero Prev.</div>
          <input class="field" id="q_number" placeholder="Prev-YYYYMMDD-001" value="" />

          <div class="label">Data</div>
          <input class="field" id="q_date" type="date" />

          <div class="label">Validità</div>
          <select class="select" id="q_validity">
            <option value="7 giorni">7 giorni</option>
            <option value="15 giorni">15 giorni</option>
            <option value="30 giorni" selected>30 giorni</option>
            <option value="60 giorni">60 giorni</option>
          </select>

          <div class="label">Riferimento</div>
          <input class="field" id="q_ref" value="Nome Agente" />
        </div>
      </div>

      <div class="titleRow">
        <h1>PREVENTIVO</h1>
        <div class="redLine"></div>
      </div>

      <div class="section">
        <h2>Dati cliente</h2>
        <div class="twoCol">
          <div class="kv">
            <div class="label">Ragione sociale</div><input class="field" id="c_company" placeholder="Ragione sociale" />
            <div class="label">Referente</div><input class="field" id="c_contact" placeholder="Nome Cognome" />
            <div class="label">Email</div><input class="field" id="c_email" placeholder="cliente@email.it" />
            <div class="label">Telefono</div><input class="field" id="c_phone" placeholder="+39 ..." />
          </div>

          <div class="kv">
            <div class="label">Indirizzo</div><input class="field" id="c_address" placeholder="Via, CAP, Città" />
            <div class="label">P.IVA / CF</div><input class="field" id="c_vat" placeholder="IT... / CF..." />
            <div class="label">Codice destinatario</div><input class="field" id="c_sdicode" placeholder="XXXXXXX" />
            <div class="label">PEC</div><input class="field" id="c_pec" placeholder="pec@pec.it" />
          </div>
        </div>
      </div>

      <div class="section">
        <h2>Voci di preventivo</h2>
        <div class="itemsWrap">
          <table>
            <thead>
              <tr>
                <th class="colNum">#</th>
                <th class="colDesc">Descrizione</th>
                <th class="colTiny">Q.tà</th>
                <th class="colSmall">Prezzo unit.</th>
                <th class="colTiny">Sconto %</th>
                <th class="colTiny">IVA %</th>
                <th class="colTotal">Totale riga</th>
                <th style="width:44px;"></th>
              </tr>
            </thead>
            <tbody id="itemsBody">
              <!-- rows injected -->
            </tbody>
          </table>
          <div class="hint">Suggerimento: usa la virgola per i decimali (es. 1,50). Il totale viene calcolato automaticamente.</div>
        </div>
        <div class="blueRule"></div>
      </div>

      <div class="bottomGrid">
        <div>
          <div class="section" style="margin-top:0">
            <h2>Note</h2>
            <textarea class="noteBox" id="q_notes" placeholder="Note, condizioni, tempi di consegna, modalità di pagamento..."></textarea>
          </div>
        </div>

        <div>
          <div class="section" style="margin-top:0">
            <h2>Riepilogo</h2>
            <div class="summary">
              <h3>Riepilogo</h3>
              <div class="sumRow"><span>Subtotale</span><strong id="sum_sub">0,00 €</strong></div>
              <div class="sumRow"><span>Sconto totale</span><strong id="sum_disc">0,00 €</strong></div>
              <div class="sumRow"><span>Imponibile</span><strong id="sum_taxable">0,00 €</strong></div>
              <div class="sumRow"><span>IVA totale</span><strong id="sum_vat">0,00 €</strong></div>
              <div class="sumRow sumTotal"><span>TOTALE</span><strong id="sum_total">0,00 €</strong></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- PDF summary root (off-screen) -->
  <div class="pdfRoot" id="pdfRoot" aria-hidden="true"></div>

  <div class="toast" id="toast">Messaggio</div>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    // ===== Utilities =====
    const MAX_ROWS = 5;
    const COUNTER_KEY = 'seemax_quote_global_seq';
    // Per azzerare il contatore (solo per fine test): apri la Console (F12) e lancia: SEEMAX_RESET_COUNTER()

    const eurFmt = new Intl.NumberFormat('it-IT', { style:'currency', currency:'EUR' });

    function parseNum(v){
      if(v === null || v === undefined) return 0;
      const s = String(v).trim().replace(/\./g,'').replace(',', '.');
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    function clamp(n,min,max){ return Math.min(Math.max(n,min),max); }

    function toast(msg){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(()=> el.classList.remove('show'), 2200);
    }

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function pad3(n){ return String(n).padStart(3,'0'); }

    function migrateOldCountersIfNeeded(){
      // Migrazione: versioni vecchie salvavano un contatore "per giorno" (seemax_quote_seq_YYYYMMDD).
      // Se il contatore globale non esiste ancora, prendiamo il massimo trovato per evitare duplicati.
      try{
        if(localStorage.getItem(COUNTER_KEY) !== null) return;
        let max = 0;
        for(let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if(!k) continue;
          if(/^seemax_quote_seq_\d{8}$/.test(k)){
            const v = Number(localStorage.getItem(k) || '0') || 0;
            if(v > max) max = v;
          }
        }
        if(max > 0) localStorage.setItem(COUNTER_KEY, String(max));
      }catch(e){ /* ignore */ }
    }

    
    function nextQuoteNumber(){
      migrateOldCountersIfNeeded();
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const ymd = `${y}${m}${dd}`;
      const cur = Number(localStorage.getItem(COUNTER_KEY) || '0') || 0;
      const nxt = cur + 1;
      localStorage.setItem(COUNTER_KEY, String(nxt));
      return `Prev-${ymd}-${pad3(nxt)}`;
    }

    function sanitizeFilename(s){
      return String(s || 'Preventivo')
        .normalize('NFKD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/[^\w\-]+/g,'_')
        .replace(/_+/g,'_')
        .replace(/^_+|_+$/g,'')
        .slice(0, 80) || 'Preventivo';
    }

    // ===== Data model =====

    // ===== Data model =====
    let rows = [];
    let pageQuoteNumber = '';


    function defaultRow(){
      return { desc:'', qty:1, price:0, disc:0, vat:22 };
    }

    function ensureMinRows(){
      if(rows.length === 0) rows.push(defaultRow());
    }

    // ===== Rendering =====
    function renderRows(){
      const body = document.getElementById('itemsBody');
      body.innerHTML = '';

      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td class="colNum">${idx+1}</td>
          <td class="colDesc">
            <input class="cellInput" data-k="desc" data-i="${idx}" placeholder="Prodotto / descrizione..." value="${escapeHtml(r.desc)}"/>
          </td>
          <td class="colTiny">
            <input class="cellInput cellInputNum" data-k="qty" data-i="${idx}" inputmode="decimal" value="${String(r.qty).replace('.',',')}"/>
          </td>
          <td class="colSmall">
            <input class="cellInput cellInputNum" data-k="price" data-i="${idx}" inputmode="decimal" value="${String(r.price).replace('.',',')}"/>
          </td>
          <td class="colTiny">
            <input class="cellInput cellInputNum" data-k="disc" data-i="${idx}" inputmode="decimal" value="${String(r.disc).replace('.',',')}"/>
          </td>
          <td class="colTiny">
            <input class="cellInput cellInputNum" data-k="vat" data-i="${idx}" inputmode="decimal" value="${String(r.vat).replace('.',',')}"/>
          </td>
          <td class="colTotal" id="rowTotal_${idx}">0,00 €</td>
          <td style="text-align:right;">
            <button class="removeBtn" data-act="remove" data-i="${idx}" title="Rimuovi riga">×</button>
          </td>
        `;
        body.appendChild(tr);
      });

      updateAddBtnState();
      recalcAll();
    }

    function updateAddBtnState(){
      const btn = document.getElementById('btnAdd');
      btn.disabled = rows.length >= MAX_ROWS;
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // ===== Calculations =====
    function calcLine(r){
      const qty = clamp(parseNum(r.qty), 0, 1e9);
      const price = clamp(parseNum(r.price), 0, 1e12);
      const disc = clamp(parseNum(r.disc), 0, 100);
      const vat = clamp(parseNum(r.vat), 0, 100);

      const net = qty * price;
      const discAmt = net * (disc/100);
      const taxable = net - discAmt;
      const vatAmt = taxable * (vat/100);
      const gross = taxable + vatAmt;
      return { net, discAmt, taxable, vatAmt, gross };
    }

    function recalcAll(){
      let sub=0, disc=0, taxable=0, vat=0, total=0;

      rows.forEach((r, idx) => {
        const c = calcLine(r);
        sub += c.net;
        disc += c.discAmt;
        taxable += c.taxable;
        vat += c.vatAmt;
        total += c.gross;

        const rt = document.getElementById(`rowTotal_${idx}`);
        if(rt) rt.textContent = eurFmt.format(c.gross);
      });

      document.getElementById('sum_sub').textContent = eurFmt.format(sub);
      document.getElementById('sum_disc').textContent = eurFmt.format(disc);
      document.getElementById('sum_taxable').textContent = eurFmt.format(taxable);
      document.getElementById('sum_vat').textContent = eurFmt.format(vat);
      document.getElementById('sum_total').textContent = eurFmt.format(total);
    }

    
    function validateBeforePdf(){
      // At least one row with description
      const hasItem = rows.some(r => String(r.desc||'').trim().length > 0);
      if(!hasItem){
        toast('Inserisci almeno una voce (descrizione).');
        return false;
      }
      const num = getField('q_number');
      if(!num){
        // Non incrementiamo il contatore qui: il numero avanza solo all'apertura pagina
        document.getElementById('q_number').value = pageQuoteNumber || '';
        toast('Numero preventivo ripristinato');
      }
      return true;
    }

    // ===== Events =====
    document.addEventListener('input', (e) => {
      const t = e.target;
      if(!t || !t.dataset) return;
      const i = Number(t.dataset.i);
      const k = t.dataset.k;
      if(!Number.isFinite(i) || !k) return;

      if(k === 'desc'){
        rows[i].desc = t.value;
      }else{
        rows[i][k] = t.value;
      }
      recalcAll();
    });

    document.addEventListener('click', (e) => {
      const t = e.target;
      if(!t) return;

      if(t.id === 'btnAdd'){
        if(rows.length >= MAX_ROWS){
          toast(`Limite massimo: ${MAX_ROWS} righe`);
          return;
        }
        rows.push(defaultRow());
        renderRows();
        return;
      }

      if(t.id === 'btnReset'){
        if(confirm('Vuoi resettare il preventivo?')){
          resetAll();
        }
        return;
      }

      if(t.id === 'btnPdf'){
        if(!validateBeforePdf()) return;
        downloadPdf().catch(err => {
          console.error(err);
          alert('Impossibile generare il PDF. Verifica la connessione (CDN) e riprova.');
        });
        return;
      }

      if(t.dataset && t.dataset.act === 'remove'){
        const i = Number(t.dataset.i);
        if(rows.length <= 1){
          toast('Serve almeno 1 riga');
          return;
        }
        rows.splice(i,1);
        renderRows();
      }
    });

    function resetAll(){
      // reset to defaults
      document.getElementById('q_number').value = pageQuoteNumber || document.getElementById('q_number').value;
      document.getElementById('q_date').value = todayISO();
      document.getElementById('q_validity').value = '30 giorni';
      document.getElementById('q_ref').value = '';

      ['c_company','c_contact','c_email','c_phone','c_address','c_vat','c_sdicode','c_pec','q_notes']
        .forEach(id => document.getElementById(id).value = '');

      rows = [defaultRow()];
      renderRows();
      toast('Reset completato');
    }

    // ===== PDF =====
    function getField(id){ return (document.getElementById(id)?.value ?? '').trim(); }

    function buildPdfDom(){
      const pdfRoot = document.getElementById('pdfRoot');

      // Build a static snapshot (same look, no inputs)
      const headerNumber = getField('q_number') || '-';
      const dateVal = getField('q_date') || '-';
      const validity = document.getElementById('q_validity').value;
      const ref = getField('q_ref') || '-';

      const clientLeft = [
        ['Ragione sociale', getField('c_company')],
        ['Referente', getField('c_contact')],
        ['Email', getField('c_email')],
        ['Telefono', getField('c_phone')],
      ];
      const clientRight = [
        ['Indirizzo', getField('c_address')],
        ['P.IVA / CF', getField('c_vat')],
        ['Cod. destinatario', getField('c_sdicode')],
        ['PEC', getField('c_pec')],
      ];

      // Totals
      let sub=0, disc=0, taxable=0, vat=0, total=0;
      const rowCalcs = rows.map(r => {
        const c = calcLine(r);
        sub += c.net; disc += c.discAmt; taxable += c.taxable; vat += c.vatAmt; total += c.gross;
        return c;
      });

      const notes = getField('q_notes');

      const rowsHtml = rows.map((r, idx) => {
        const c = rowCalcs[idx];
        const qty = String(parseNum(r.qty)).replace('.',',');
        const price = eurFmt.format(parseNum(r.price));
        const discPct = `${clamp(parseNum(r.disc),0,100).toFixed(0)}%`;
        const vatPct = `${clamp(parseNum(r.vat),0,100).toFixed(0)}%`;
        const totalLine = eurFmt.format(c.gross);
        const desc = escapeHtml(r.desc || '');
        return `
          <tr>
            <td class="colNum">${idx+1}</td>
            <td class="colDesc"><div class="pdfText" title="${desc}">${desc || '&nbsp;'}</div></td>
            <td class="colTiny"><div class="pdfText" style="text-align:center">${qty}</div></td>
            <td class="colSmall"><div class="pdfText" style="text-align:center">${price}</div></td>
            <td class="colTiny"><div class="pdfText" style="text-align:center">${discPct}</div></td>
            <td class="colTiny"><div class="pdfText" style="text-align:center">${vatPct}</div></td>
            <td class="colTotal">${totalLine}</td>
            <td style="width:44px;"></td>
          </tr>
        `;
      }).join('');

      const kvBlock = (pairs) => pairs.map(([k,v]) => `
        <div class="label">${escapeHtml(k)}</div>
        <div class="pdfText" title="${escapeHtml(v||'')}">${escapeHtml(v||'')}</div>
      `).join('');

      pdfRoot.innerHTML = `
        <div class="sheet">
          <div class="header">
            <div class="logoBanner">
              <img class="logoImg" src="./logo.png" alt="Seemax" />
            </div>

            <div class="metaGrid">
              <div class="label">Numero Prev.</div><div class="pdfText">${escapeHtml(headerNumber)}</div>
              <div class="label">Data</div><div class="pdfText">${escapeHtml(formatDateIT(dateVal))}</div>
              <div class="label">Validità</div><div class="pdfText">${escapeHtml(validity)}</div>
              <div class="label">Riferimento</div><div class="pdfText">${escapeHtml(ref)}</div>
            </div>
          </div>

          <div class="titleRow" style="margin-top:12px">
            <h1>PREVENTIVO</h1>
            <div class="redLine"></div>
          </div>

          <div class="section">
            <h2>Dati cliente</h2>
            <div class="twoCol">
              <div class="kv">${kvBlock(clientLeft)}</div>
              <div class="kv">${kvBlock(clientRight)}</div>
            </div>
          </div>

          <div class="section">
            <h2>Voci di preventivo</h2>
            <div class="itemsWrap">
              <table>
                <thead>
                  <tr>
                    <th class="colNum">#</th>
                    <th class="colDesc">Descrizione</th>
                    <th class="colTiny">Q.tà</th>
                    <th class="colSmall">Prezzo unit.</th>
                    <th class="colTiny">Sconto %</th>
                    <th class="colTiny">IVA %</th>
                    <th class="colTotal">Totale riga</th>
                    <th style="width:44px;"></th>
                  </tr>
                </thead>
                <tbody>${rowsHtml}</tbody>
              </table>
            </div>
            <div class="blueRule"></div>
          </div>

          <div class="bottomGrid" style="margin-top:12px">
            <div>
              <div class="section" style="margin-top:0">
                <h2>Note</h2>
                <div class="noteBox" style="min-height:72px; white-space:pre-wrap;">${escapeHtml(notes)}</div>
              </div>
            </div>

            <div>
              <div class="section" style="margin-top:0">
                <h2>Riepilogo</h2>
                <div class="summary">
                  <h3>Riepilogo</h3>
                  <div class="sumRow"><span>Subtotale</span><strong>${eurFmt.format(sub)}</strong></div>
                  <div class="sumRow"><span>Sconto totale</span><strong>${eurFmt.format(disc)}</strong></div>
                  <div class="sumRow"><span>Imponibile</span><strong>${eurFmt.format(taxable)}</strong></div>
                  <div class="sumRow"><span>IVA totale</span><strong>${eurFmt.format(vat)}</strong></div>
                  <div class="sumRow sumTotal"><span>TOTALE</span><strong>${eurFmt.format(total)}</strong></div>
                </div>
              </div>
            </div>
          </div>


          <div class="signRow">
            <div class="signBox">
              <div class="signTitle">Firma cliente</div>
              <div class="signLine"></div>
            </div>
            <div class="signBox">
              <div class="signTitle">Firma agente</div>
              <div class="signLine"></div>
            </div>
          </div>

        </div>
      `;
    }

    function formatDateIT(iso){
      // iso: YYYY-MM-DD
      if(!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso || '-';
      const [y,m,d] = iso.split('-');
      return `${d}/${m}/${y}`;
    }

    async function waitForImages(container){
      const imgs = Array.from(container.querySelectorAll('img'));
      await Promise.all(imgs.map(img => {
        if(img.complete && img.naturalWidth > 0) return Promise.resolve();
        return new Promise((resolve) => {
          img.addEventListener('load', resolve, {once:true});
          img.addEventListener('error', resolve, {once:true}); // resolve anyway
        });
      }));
    }

    async function downloadPdf(){
      if(typeof html2canvas !== 'function' || !window.jspdf?.jsPDF){
        alert('Librerie PDF non disponibili (CDN).');
        return;
      }

      // build DOM snapshot
      buildPdfDom();
      const pdfRoot = document.getElementById('pdfRoot');
      await waitForImages(pdfRoot);

      const canvas = await html2canvas(pdfRoot, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true,
        logging: false,
        windowWidth: pdfRoot.scrollWidth,
        windowHeight: pdfRoot.scrollHeight
      });

      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;

      const pdf = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });

      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      const imgW = canvas.width;
      const imgH = canvas.height;

      const scale = Math.min(pageW / imgW, pageH / imgH);
      const w = imgW * scale;
      const h = imgH * scale;
      const x = (pageW - w) / 2;
      const y = (pageH - h) / 2;

      pdf.addImage(imgData, 'PNG', x, y, w, h, undefined, 'FAST');

      const safeNumber = (getField('q_number') || 'Preventivo').replace(/[^\w\-]+/g,'_');
      pdf.save(`${safeNumber}.pdf`);
    }

    // ===== init =====
    (function init(){
      // Logo fallback if missing
      const logo = document.getElementById('logoImg');
      logo.addEventListener('error', () => {
        logo.replaceWith(Object.assign(document.createElement('div'), {
          textContent: 'SEEMAX',
          style: 'font-weight:900;color:#1f3a8a;letter-spacing:.14em'
        }));
      }, { once:true });

      // Helper: reset contatore (solo per test)
      window.SEEMAX_RESET_COUNTER = function(){
        try{
          localStorage.removeItem(COUNTER_KEY);
          alert('Contatore azzerato. Al prossimo refresh ripartirà da 001.');
        }catch(e){
          alert('Impossibile azzerare il contatore (localStorage non disponibile).');
        }
      };

      function initDefaults(){
        // Ogni apertura pagina: nuovo numero progressivo + form vuoto
        pageQuoteNumber = nextQuoteNumber();
        document.getElementById('q_number').value = pageQuoteNumber;
        document.getElementById('q_date').value = todayISO();
        document.getElementById('q_validity').value = '30 giorni';
        document.getElementById('q_ref').value = '';

        ['c_company','c_contact','c_email','c_phone','c_address','c_vat','c_sdicode','c_pec','q_notes']
          .forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; });

        rows = [defaultRow()];
        renderRows();
      }

      // Se il browser ripristina la pagina dalla cache (bfcache), forziamo reset + nuovo numero
      window.addEventListener('pageshow', (ev) => {
        if(ev.persisted) initDefaults();
      });

      initDefaults();
    })();
  </script>
</body>
</html>
